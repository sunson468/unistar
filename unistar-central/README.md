# Unistar中心(xc-unistar-central)

### 中心介绍

Unistar中心是一个综合的微服务管理中心，包括不限于配置中心，配置动态刷新、服务的注册和发现、服务链路日志、任务调度等。

Unistar中心是一个集成度很高的微服务中心，包含了大多数常见的微服务功能，相比其他的微服务框架，Unistar仅需要启动一个应用即可。

### 功能介绍

#### 1. 分布式、高可用

支持启动多中心，并借助Nginx等负载均衡中间服务来达到高可用的目的。

多中心之间的通讯采用基于缓存的订阅和发布，并设计一套事件监听机制，同时借助 [基于时间周期的投票共识算法](https://www.up1234567.com/blog/#/view/31410ee4d0bc9c283254b565f022a359) 来确保Master的选取唯一性，而该套算法没有2N+1的限制，也就是你可以启动1台、2台、3台或者4台。

在共识算法的具体实现中，Unistar中心还加入了内存资源的排序，力求将资源最宽裕的中心设置为Master。

#### 2. 持久化

持久化方式目前支持MongoDB和MySQL两种模式。

持久化的核心是基于MongoDB的实体定义方式，在此基础上提炼了一个公共Dao，并在此基础上实现了MongoDB和MySQL的两套实现，可以在启动参数内指定持久化方式。

持久化的Dao接口定义：`IUnistarDao`

> 注意：在查询条件上，支持条件查询(=、!=、>=、<=、>、<)，且仅支持AND条件；查询条件使用方式为属性名尾部拼接条件符号，例如 Map{ "amount>=":123 }

#### 3. 缓存

Unistar的缓存目前支持内存和Redis两种模式。

Unistar的持久化的接口定义：`IUnistarCache`

> 注意：缓存定义中包含了发布和订阅实现，如果自定义新的实现，则对于clust可为true的环境下必须支持

#### 4. 应用、节点管理

对于微服务系统中的服务都命名为应用，一个服务名对应一个应用。

对于启动的实际服务，都关联于对应服务名，并且称为节点，节点就代表着一个具体运行着的服务。

内部对于节点、配置都是依赖于应用的。

内部对于统计、跟踪，动态刷新配置、服务发现、任务调度、日志开关都是具体到节点。

> 服务的节点与中心之间采用WebSocket连接，可以实时同步服务的状态

#### 5. 空间、分组管理

为了便于一套微服务中心可以被多个独立场景下使用，设计了一套多空间模式，不同的空间之间的应用、应用配置和节点等都相互不可见。

为了让同一个空间下的应用进行归类，设计了分组的概念，分组可用于机房区分，或者智能区分，比如在调度系统中，就可以指定所属组调度，使得应用的职能获得更为````````细致的划分。

空间和分组都只能是超级管理员才可以配置

#### 6. 配置中心和动态刷新机制

配置中心实现了配置的继承和多profile的支持。

配置中心默认一定会加载无profile标记的配置，其他的profile配置会按照asc码顺序的过程覆盖加载。

配置中心可以针对节点进行临时的动态刷新，该功能可运用于数值控制、功能开关等，具体可以参考[Unistar SpringCloud](./xc-unistar-springcloud)模块介绍。  

#### 7. 服务注册中心

应用启动的时候可以配置是否注册为服务，注册为服务的节点会加入到服务列表，供服务发现者获取。

应用启动的时候可以标记为暂不可用状态，服务发现者会加载该服务节点，但调用时会跳过，除非服务节点更改为可用状态。

#### 8. 服务发现、同步、统计，跟踪、限流

所有应用启动的时候都是为服务发现者。

- 服务发现

    微服务的发现采用的是按需加载制，也就是在初次启动的时候，服务发现者并不会加载所有的服务列表，只有当某个微服务首次被请求时，服务发现者才会向服务中心请求该服务的节点列表，所以初次调用某个微服务可能会有一定的同步延迟(100ms~500ms)。

- 同步、统计

    当管理员在Unistar中心控台开放或者关闭某个服务，或者某个服务因故掉线时，Unistar中心就会通过WebSocket实时同步至服务发现者。

    服务发现者每隔一分钟会向Unistar中心提交心跳报文，并将近一分钟内的请求统计数据发送至Unistar中心。
    
    服务节点的统计数据包含了一分钟内的最大QPS，请求次数，异常次数，请求毫秒数(最少、最多以及总计)

- 跟踪

    管理员可以在Unistar中心控台针对某个网关请求进行监控，服务发现者就会启动监控，并将监控标识传递至所有关联的微服务请求中，管理员可以在Unistar中心控台看到该请求在整个微服务系统中的请求调用链。

    > 注意：请求调用链仅作用于通过OpenFeign的微服务请求，且仅支持实时监测，不会存储调用链

- 日志开关

    为解决线上日志打印排查的问题，Unistar在slf4j的基础上扩展了日志开关，可以在控制台实时控制日志的打印，极大的方便了线上问题的排查。
    
    日志开关的具体可以参考[Unistar SpringCloud](./xc-unistar-springcloud)模块介绍

- 限流

    管理员可以在Unistar中心控台添加应用限流。
    
    > 注意：针对某个服务地址的某一模式、某一限流条件以及某一限流，可配置且仅可配置一条规则
                                        
    - 限流模式
    
        分为前控制和后控制，对应的就是在Feign请求前就进行控制或者在Controller拦截层控制
    
    - 限流条件
    
        分为默认和异常熔断，默认就是一直生效，而异常熔断是指达到熔断条件的时候会启动限流，达到设定的期限后会自动恢复到不限流状态
    
        > 注意：如果默认限制和异常熔断都存在的情况下，将采用异常熔断限制

    - 限流处理
    
        分为快速失败和线程等待，快速失败即立刻抛出异常，线程等待则表示请求会等待设定的超时时间，若超过超过时间同样抛出异常
    
        > 异常类：UnistarLimitException
    
    - 限流白名单
    
        默认情况下，Controller层级的限流针对所有来源，可通过分组的白名单或服务名的白名单来跳过限流控制
        
        > 注意：非内部服务应用无法设置白名单，内部服务标志根据实际运行情况系统会自动判定，所以需要系统运行一段时间

#### 9. 任务注册和调度

当实现了任务监听的应用启动时会向Unistar中心发起任务注册请求，Unistar中心会标记该应用为任务执行器。

任务执行器可以进行分组，管理员在后台设置任务调度时可以设置仅调度某些分组的任务执行器。

任务调度支持单次调用和并行调用。

当任务调度为单次调用时，支持后续调度配置，形成调度链，调度链支持返回值传递。

任务监听的具体可以参考[Unistar SpringCloud](./xc-unistar-springcloud)模块介绍

### 部署

可以直接下载 [编译好的Jar包](https://gitee.com/sunson468/unistar/releases/1.0.RC) 

启动脚本可参考[Linux应用启动和停止脚本](https://www.up1234567.com/blog/#/view/6b50e81f89a56f69c2b9f21c53ecd2b9)

如果打算分布式部署，必须要用Nginx做前置，Redis做缓存。

数据库支持MongoDB和MySQL，如果是MySQL则需要先执行初始化脚本，参考项目/doc/sql/unistar_mysql.sql

### 配置参数

```yaml
unistar:
  # 是否支持Clust，默认支持，单台也可以设置为true
  # 设置为false，则与节点的通讯不会经过发布订阅系统，而直接从连接管理中发起请求
  clust: true
  # 持久化方式，目前支持MongoDB和MySQL
  data:
    # mongodb | mysql
    type: mongodb
    uri: "mongodb://localhost:27017/XC_UNISTAR?connectTimeoutMS=10000"
    # uri: "jdbc:mysql://localhost:3306/xc_unistar?useUnicode=true&characterEncoding=utf8"
    # username: ""
    # password: ""
  # 缓存方式
  # 如果缓存设置为memory，则clust必须为false
  cache:
    # memory | redis
    type: redis
    # Redis 实现了单机、哨兵和集群模式的配置
    redis:
      # (单机 | 哨兵 | 集群) 模式下支持的参数
      host: "localhost"
      port: 16379
      # password: ""
      database: 10
      # (哨兵) 模式下支持的参数
      # master: ""
      # (哨兵 | 集群) 模式下支持的参数
      # ip1:port2;ip2:port2
      # nodes: ""
```
  
